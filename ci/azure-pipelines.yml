# Copyright SecureKey Technologies Inc. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0

name: $(SourceBranchName)-$(Date:yyyyMMdd).$(Rev:r)
variables:
  GO_VERSION: 1.12.5
  GOPATH: $(Agent.BuildDirectory)/go

jobs:
  - job: UnitTest
    pool:
      vmImage: ubuntu-16.04
    timeoutInMinutes: 30
    steps:
    - template: azp-dependencies.yml
    - checkout: self
    - script: |
        echo ${GOPATH}
        ls -alh ${GOPATH}
        ls -alh ${GOPATH}/src
        ls -alh ${GOPATH}/src/github.com/hyperledger/fabric
        ls -alh ${GOPATH}/src/github.com/hyperledger/fabric/sampleconfig
        mkdir -p ${GOPATH}/src/github.com/hyperledger/fabric
        ln -s pkg/testutil/sampleconfig ${GOPATH}/src/github.com/hyperledger/fabric
        ls -alh ${GOPATH}
        ls -alh ${GOPATH}/src
        ls -alh ${GOPATH}/src/github.com/hyperledger/fabric
        ls -alh ${GOPATH}/src/github.com/hyperledger/fabric/sampleconfig
        make unit-test
      displayName: Run checks and unit test
      env:
        # GOPATH is needed for the test utility GetDevConfigDir
        GOPATH: $(GOPATH)
    - script: bash <(curl https://codecov.io/bash)
      displayName: Upload coverage to Codecov 

  - job: BDDTest
    pool:
      vmImage: ubuntu-16.04
    timeoutInMinutes: 60
    steps:
    - template: azp-dependencies.yml
    - checkout: self
    - script: make bddtests
      displayName: Run BDD tests
